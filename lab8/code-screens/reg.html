<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Code screen</title>
    </head>
    <body>
        <main>
            <pre><code>        [HttpPost]<br/>        public async Task&lt;IActionResult&gt; Register(RegisterViewModel model)<br/>        {<br/>            if (User.Identity.IsAuthenticated)<br/>                return RedirectToAction(&quot;Index&quot;, &quot;Cabinet&quot;);<br/>            AnalyzeLang(null);<br/>            var lang = ViewBag.Lang;<br/>            model.AllGenres = _genreService.GetAll().Select(g =&gt; new GenreViewModel()<br/>            {<br/>                Id = g.Id,<br/>                Name = _genreService.GetNameForLang(g, lang)<br/>            });<br/>            var emailChecker = new EmailAddressAttribute();<br/>            if (string.IsNullOrEmpty(model.Email) || !emailChecker.IsValid(model.Email))<br/>            {<br/>                ModelState.AddModelError(&quot;WrongEmail&quot;, &quot;Not a valid or empty email&quot;);<br/>                return View(model);<br/>            }<br/>            if (string.IsNullOrEmpty(model.FirstName))<br/>            {<br/>                ModelState.AddModelError(&quot;NoFirstName&quot;, &quot;First name cannot be empty&quot;);<br/>                return View(model);<br/>            }<br/>            if (string.IsNullOrEmpty(model.LastName))<br/>            {<br/>                ModelState.AddModelError(&quot;NoLastName&quot;, &quot;Last name cannot be empty&quot;);<br/>                return View(model);<br/>            }<br/>            if (!(model.PhoneNumber is null))<br/>            {<br/>                if (model.PhoneNumber.Length != 12 || !model.PhoneNumber.All(char.IsDigit)<br/>                || !model.PhoneNumber.StartsWith(&quot;38&quot;))<br/>                {<br/>                    ModelState.AddModelError(&quot;WrongPhoneNumber&quot;, &quot;Phone number is not in format 38XXXXXXXXXX&quot;);<br/>                    return View(model);<br/>                }<br/>                else if (_userManager.Users.Select(u =&gt; u.PhoneNumber).Contains(model.PhoneNumber))<br/>                {<br/>                    ModelState.AddModelError(&quot;WrongPhoneNumber&quot;, $&quot;Phone number {model.PhoneNumber} is already taken&quot;);<br/>                    return View(model);<br/>                }<br/>            }<br/>            var user = new User()<br/>            {<br/>                    FirstName = model.FirstName,<br/>                    LastName = model.LastName,<br/>                    Email = model.Email,<br/>                    NormalizedEmail = model.Email.ToUpperInvariant(),<br/>                    UserName = model.Email,<br/>                    NormalizedUserName = model.Email.ToUpperInvariant(),<br/>                    PhoneNumber = model.PhoneNumber<br/>            };<br/>            var result = await _userManager.CreateAsync(user, model.Password);<br/>            if (result.Succeeded)<br/>            {<br/>                await _userManager.AddToRoleAsync(user, &quot;Користувач&quot;);<br/>                var signInResult = await _signInManager.PasswordSignInAsync(model.Email, model.Password, false, false);<br/>                if (signInResult.Succeeded)<br/>                {<br/>                    GenreModel genre;<br/>                    foreach (var genreId in model.Genres)<br/>                    {<br/>                        genre = await _genreService.GetByIdAsync(genreId);<br/>                        try<br/>                        {<br/>                            await _genreService.AddUserToGenreAsync(genre, user.Id);<br/>                        }<br/>                        catch (Exception) { }<br/>                    }<br/>                    return RedirectToAction(&quot;Index&quot;, &quot;Cabinet&quot;);<br/>                }<br/>                else<br/>                {<br/>                    foreach (var error in result.Errors)<br/>                        ModelState.AddModelError(&quot;SignInAfterRegistrationError&quot;, error.Description);<br/>                }<br/>            }<br/>            else<br/>            {<br/>                foreach (var error in result.Errors)<br/>                    ModelState.AddModelError(&quot;RegistrationError&quot;, error.Description);<br/>            }<br/>            return View(model);<br/>        }<br/></code></pre>
        </main>
    </body>
</html>